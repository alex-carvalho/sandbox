# Docker Storage Documentation

## Docker Volumes

### What are Docker Volumes?
Docker volumes are the preferred mechanism for persisting data generated by and used by Docker containers. Unlike bind mounts, volumes are completely managed by Docker and provide better portability and performance.

### How to Use Docker Volumes

#### Creating Volumes
```bash
# Create a named volume
docker volume create my-volume

# Create volume with specific driver
docker volume create --driver local my-local-volume
```

#### Using Volumes in Containers
```bash
# Mount named volume
docker run -v my-volume:/app/data nginx

# Mount anonymous volume
docker run -v /app/data nginx

# Using --mount syntax (recommended)
docker run --mount source=my-volume,target=/app/data nginx
```

#### Volume Management
```bash
# List volumes
docker volume ls

# Inspect volume
docker volume inspect my-volume

# Remove volume
docker volume rm my-volume

# Remove unused volumes
docker volume prune
```

### Types of Docker Volumes

#### 1. Named Volumes
- Explicitly created and managed by Docker
- Stored in Docker's managed directory
- Can be shared between containers
- Persist after container removal

```bash
docker volume create app-data
docker run -v app-data:/data nginx
```

#### 2. Anonymous Volumes
- Created automatically when container starts
- Removed when container is removed (unless --rm is not used)
- Useful for temporary data

```bash
docker run -v /tmp nginx
```

#### 3. Bind Mounts
- Mount host directory/file into container
- Direct access to host filesystem
- Less portable than volumes

```bash
docker run -v /host/path:/container/path nginx
docker run --mount type=bind,source=/host/path,target=/container/path nginx
```

#### 4. tmpfs Mounts
- Store data in host memory
- Data doesn't persist after container stops
- Useful for sensitive temporary data

```bash
docker run --tmpfs /tmp nginx
docker run --mount type=tmpfs,destination=/tmp nginx
```

## Volume Drivers

### What are Volume Drivers?
Volume drivers enable Docker to use external storage systems and provide different storage backends for volumes.

### Built-in Volume Drivers

#### 1. local (Default)
- Stores data on Docker host's local filesystem
- Most commonly used driver
- Supports bind mounts and named volumes

```bash
docker volume create --driver local my-volume
```

#### 2. local with Options
```bash
# Create volume with specific mount options
docker volume create --driver local \
  --opt type=nfs \
  --opt o=addr=192.168.1.100,rw \
  --opt device=:/path/to/dir \
  nfs-volume
```

### Popular Third-Party Volume Drivers

#### 1. NFS Driver
```bash
# Install NFS plugin
docker plugin install store/sumologic/docker-nfs-driver:1.0.0

# Create NFS volume
docker volume create --driver sumologic/docker-nfs-driver \
  --opt server=nfs-server.example.com \
  --opt share=/exported/path \
  nfs-volume
```

#### 2. AWS EBS Driver
```bash
# Install REX-Ray plugin
docker plugin install rexray/ebs

# Create EBS volume
docker volume create --driver rexray/ebs \
  --opt size=10 \
  --opt volumetype=gp2 \
  ebs-volume
```

#### 3. Flocker Driver
```bash
docker volume create --driver flocker \
  --opt size=20GB \
  flocker-volume
```

### Most Used Volume Driver Options

#### Local Driver Options
```bash
# Bind mount with options
docker volume create --driver local \
  --opt type=none \
  --opt o=bind \
  --opt device=/host/path \
  bind-volume

# tmpfs with size limit
docker volume create --driver local \
  --opt type=tmpfs \
  --opt device=tmpfs \
  --opt o=size=100m \
  tmpfs-volume
```

#### Common Driver Options
- `type`: Filesystem type (nfs, tmpfs, ext4, etc.)
- `o`: Mount options (rw, ro, size, etc.)
- `device`: Source device or path
- `size`: Volume size
- `volumetype`: Storage type (for cloud providers)

## Storage Drivers

### What are Storage Drivers?
Storage drivers control how images and containers are stored and managed on Docker host. They handle the layered filesystem that makes Docker containers efficient.

### Available Storage Drivers

#### 1. overlay2 (Recommended)
- Default driver for most Linux distributions
- Best performance and stability
- Supports multiple lower layers

```bash
# Check current storage driver
docker info | grep "Storage Driver"

# Configure in daemon.json
{
  "storage-driver": "overlay2"
}
```

#### 2. aufs
- Legacy driver
- Good for older kernels
- Being phased out

#### 3. devicemapper
- Uses thin provisioning and snapshots
- Good for RHEL/CentOS older versions
- Requires configuration

```json
{
  "storage-driver": "devicemapper",
  "storage-opts": [
    "dm.thinpooldev=/dev/mapper/docker-thinpool",
    "dm.use_deferred_removal=true",
    "dm.use_deferred_deletion=true"
  ]
}
```

#### 4. btrfs
- Uses Btrfs filesystem features
- Good for Btrfs-based systems
- Supports snapshots natively

#### 5. zfs
- Uses ZFS filesystem
- Excellent for data integrity
- Good snapshot support

#### 6. vfs
- No copy-on-write support
- Poor performance
- Used for testing only

### Most Used Storage Driver Options

#### overlay2 Configuration
```json
{
  "storage-driver": "overlay2",
  "storage-opts": [
    "overlay2.override_kernel_check=true",
    "overlay2.size=20G"
  ]
}
```

#### devicemapper Configuration
```json
{
  "storage-driver": "devicemapper",
  "storage-opts": [
    "dm.thinpooldev=/dev/mapper/docker-thinpool",
    "dm.use_deferred_removal=true",
    "dm.use_deferred_deletion=true",
    "dm.loopdatasize=200G",
    "dm.loopmetadatasize=4G",
    "dm.fs=ext4",
    "dm.mkfsarg=-F",
    "dm.mountopt=discard"
  ]
}
```

### Storage Driver Selection Guidelines

#### Choose overlay2 when:
- Using modern Linux kernel (4.0+)
- Need best performance
- Default choice for most scenarios

#### Choose devicemapper when:
- Using RHEL/CentOS 7 or older
- Need direct-lvm configuration
- Enterprise storage requirements

#### Choose btrfs when:
- Host uses Btrfs filesystem
- Need advanced snapshot features
- Require subvolume management

#### Choose zfs when:
- Host uses ZFS filesystem
- Need maximum data integrity
- Require advanced snapshot capabilities

## Best Practices

### Volume Best Practices
1. Use named volumes for persistent data
2. Use bind mounts for development only
3. Backup volumes regularly
4. Use appropriate volume drivers for your infrastructure
5. Monitor volume usage and cleanup unused volumes

### Storage Driver Best Practices
1. Use overlay2 for new installations
2. Configure storage driver before creating containers
3. Monitor disk usage and performance
4. Use direct-lvm for production devicemapper setups
5. Regular maintenance and cleanup of unused images/containers

## Common Commands Reference

```bash
# Volume operations
docker volume create <name>
docker volume ls
docker volume inspect <name>
docker volume rm <name>
docker volume prune

# Storage info
docker info
docker system df
docker system prune

# Container with volumes
docker run -v volume-name:/path container
docker run --mount source=vol,target=/path container
```